pil2-proofman is a SNARK library used by the zisk zkvm.

## Conventions
Filenames use - (hyphen) for separators, not _ (underscore) whenever possible.

## Tests

### Setup

Before running tests, set up the proving keys:

```bash
./setup.sh              # set up all tests (simple + lookup + permutation)
./setup.sh simple       # set up only simple test
./setup.sh lookup       # set up only lookup test
./setup.sh permutation  # set up only permutation test
```

Requires `pil2-compiler` and `pil2-proofman-js` as sibling directories.

### Python Executable Spec

The Python implementation in `executable-spec/` is a complete STARK prover and verifier that produces byte-identical proofs to the C++ implementation.

**Supported AIRs:**
- **SimpleLeft**: 8 rows, basic constraints (no FRI folding)
- **Lookup2_12**: 4096 rows, complex lookup operations (has FRI folding)
- **Permutation1_6**: 64 rows, permutation constraints (has FRI folding)

**Generate test vectors** (requires setup.sh first):
```bash
./generate-test-vectors.sh              # generate all test vectors
./generate-test-vectors.sh simple       # generate SimpleLeft only
./generate-test-vectors.sh lookup       # generate Lookup2_12 only
./generate-test-vectors.sh permutation  # generate Permutation1_6 only
```

**Run Python tests:**
```bash
cd executable-spec && uv run python -m pytest tests/ -v
```

**Test suite overview (142 tests):**

| Test File | Description |
|-----------|-------------|
| `test_stark_e2e.py` | Full prover E2E tests with byte-level binary proof comparison against C++ |
| `test_verifier_e2e.py` | Verifier tests against C++ proof fixtures (*.proof.bin) |
| `test_fri.py` | FRI layer tests - folding, commitment, query generation |
| `test_stark_info.py` | StarkInfo JSON parsing validation |
| `test_proof.py` | Proof serialization/deserialization |
| `test_expressions_bin.py` | Expression bytecode parsing |
| `test_ntt.py` | NTT/INTT operations |
| `test_batch_inverse.py` | Montgomery batch inversion |

**Test data directory (`executable-spec/tests/test-data/`):**
- `*.json` - JSON test vectors with inputs, intermediates, and expected outputs
- `*.proof.bin` - Binary proofs generated by C++ prover
- `*.proof.py.bin` - Binary proofs generated by Python prover (for debugging)

**Key test classes:**
- `TestStarkE2EComplete` - Full proof generation with binary comparison to C++
- `TestFullBinaryComparison` - Byte-level proof verification
- `TestVerifierE2E` - Verifies C++ proofs pass Python verification

### C++ FRI Pinning Vectors

To regenerate C++ FRI pinning vectors (for `pil2-stark/tests/fri-pinning/fri_pinning_vectors.hpp`):

```bash
./generate-fri-vectors.sh          # regenerate all vectors (default)
./generate-fri-vectors.sh simple   # regenerate SimpleLeft only
./generate-fri-vectors.sh lookup   # regenerate Lookup2_12 only
```

## Python Executable Spec Architecture

### Package Structure

```
executable-spec/
├── primitives/          # Low-level cryptographic building blocks
│   ├── field.py         # Goldilocks field FF and cubic extension FF3
│   ├── ntt.py           # Number Theoretic Transform
│   ├── merkle_tree.py   # Merkle tree construction and proofs
│   ├── transcript.py    # Fiat-Shamir transcript (Poseidon2)
│   └── pol_map.py       # Polynomial mapping data structures
│
├── protocol/            # STARK protocol implementation
│   ├── prover.py        # Main proof generation entry point
│   ├── verifier.py      # Proof verification
│   ├── fri.py           # FRI folding protocol
│   ├── pcs.py           # FRI polynomial commitment scheme
│   ├── stages.py        # Prover stage orchestration
│   ├── expression_evaluator.py  # Constraint polynomial evaluation
│   ├── witness_generation.py    # Lookup/permutation witness
│   ├── stark_info.py    # StarkInfo JSON parser
│   ├── setup_ctx.py     # Setup context and prover helpers
│   ├── proof.py         # Proof data structures and serialization
│   └── steps_params.py  # Prover/verifier working data container
│
└── tests/               # Test suite
```

### Type System

The codebase uses galois library for field arithmetic with semantic type aliases:

```python
# Base types (from galois library)
FF   # Base field GF(p) - Goldilocks prime
FF3  # Cubic extension GF(p^3)

# Type aliases for semantic clarity (in primitives/field.py)
FF3Poly    # Polynomial over extension field (FRI, NTT)
FFPoly     # Polynomial over base field
FF3Column  # Column of values at N evaluation points
FFColumn   # Column of base field values
HashOutput # 4-element Poseidon hash output

# Constants
FIELD_EXTENSION_DEGREE = 3  # Cubic extension degree
```
