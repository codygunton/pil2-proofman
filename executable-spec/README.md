# Executable Specification

A Python implementation of the FRI (Fast Reed-Solomon Interactive Oracle Proof of Proximity) Polynomial Commitment Scheme from pil2-proofman. This serves as an executable specification for cross-validating the C++ implementation.

## Directory Structure

```
executable-spec/
├── __init__.py
├── extract_vectors.py
├── field.py
├── fri.py
├── fri_pcs.py
├── merkle_tree.py
├── poseidon2.py
├── poseidon2-ffi/
│   ├── Cargo.lock
│   ├── Cargo.toml
│   ├── pyproject.toml
│   └── src/
│       ├── constants.rs
│       └── lib.rs
├── proof_loader.py
├── requirements.txt
├── test_galois_omega.py
├── test_pinning.py
├── test_vectors.py
├── transcript.py
└── vectors/
    └── lookup2_12_2.json
```

## File Descriptions

### Core Implementation

| File | Description |
|------|-------------|
| `__init__.py` | Package entry point that exports all public APIs including field arithmetic, hashing, Merkle trees, transcript, and FRI components. |
| `field.py` | Goldilocks field (p = 2^64 - 2^32 + 1) and cubic extension arithmetic using the galois library. Provides NTT/INTT operations. |
| `fri.py` | Core FRI folding and query algorithms. Implements polynomial folding at each step and query generation for the interactive proof. |
| `fri_pcs.py` | High-level FRI Polynomial Commitment Scheme wrapper. Orchestrates the full proving flow including Merkle tree construction, transcript management, and grinding. |
| `merkle_tree.py` | Variable-arity Merkle tree implementation using Poseidon2 hashing. Supports arities 2, 3, and 4. |
| `poseidon2.py` | Python wrapper for Poseidon2 hash functions. Delegates to the Rust FFI implementation for C++-compatible results. |
| `transcript.py` | Fiat-Shamir transcript using Poseidon2 sponge construction. Converts interactive proofs to non-interactive by deterministically generating challenges. |

### Poseidon2 Rust FFI

| File | Description |
|------|-------------|
| `poseidon2-ffi/Cargo.toml` | Rust crate configuration for the PyO3-based Python extension module. |
| `poseidon2-ffi/pyproject.toml` | Maturin build configuration for compiling the Rust extension into a Python module. |
| `poseidon2-ffi/src/lib.rs` | Rust implementation of Poseidon2 permutation and hash functions matching the C++ implementation exactly. |
| `poseidon2-ffi/src/constants.rs` | Round constants for Poseidon2 extracted from the C++ implementation. These must not be modified. |

### Testing

| File | Description |
|------|-------------|
| `test_galois_omega.py` | Validates that the galois library INTT with custom omega matches the internal `_intt_small` implementation. |
| `test_pinning.py` | Pytest suite validating that Python FRI outputs match C++ golden values byte-for-byte. Tests both SimpleLeft and Lookup2_12 AIRs. |
| `test_vectors.py` | Golden test vectors extracted from C++ implementation. Contains expected inputs/outputs for pinning tests. |
| `vectors/lookup2_12_2.json` | Large input vectors for Lookup2_12 test case stored as JSON to keep test_vectors.py manageable. |

### Utilities

| File | Description |
|------|-------------|
| `extract_vectors.py` | Script to parse FRI test vectors from C++ stderr output (when CAPTURE_FRI_VECTORS is enabled) and save as JSON. |
| `proof_loader.py` | Loads and parses proof JSON files generated by the C++ implementation for cross-validation. |
| `requirements.txt` | Python dependencies: galois (for finite field arithmetic) and numpy. |

## Setup

1. Install Python dependencies:
   ```bash
   pip install -r executable-spec/requirements.txt
   ```

2. Build the Poseidon2 FFI extension:
   ```bash
   cd executable-spec/poseidon2-ffi
   maturin develop
   ```

## Usage

From within the package, use relative imports:

```python
from .fri_pcs import FriPcs, FriPcsConfig
from .transcript import Transcript

config = FriPcsConfig(
    n_bits_ext=13,
    fri_steps=[12, 8, 4],
    n_queries=228,
)
fri = FriPcs(config)
transcript = Transcript(arity=4)
proof = fri.prove(polynomial, transcript)
```

## Running Tests

```bash
python -m pytest executable-spec/test_pinning.py -v
```
